name: ðŸ Python Lint + ðŸ¤– Auto-Approve PR

on:
  pull_request_target:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  lint-and-approve:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.8", "3.9", "3.10"]
      fail-fast: false

    steps:
      # Step 1: Checkout PR branch
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.head_ref }}
          persist-credentials: false

      # Step 2: Setup Python
      - name: ðŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      # Step 3: Detect changed Python files using paths-filter
      - name: ðŸ” Detect changed Python files
        id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            python:
              - '**/*.py'

      # Step 4: Skip lint if no Python files changed
      - name: âœ… No Python files changed
        if: steps.filter.outputs.python == 'false'
        run: echo "âœ¨ No Python files changed in this PR. Skipping lint."

      # Step 5: Install dependencies and run Pylint
      - name: ðŸ Install dependencies
        if: steps.filter.outputs.python == 'true'
        run: |
          python -m pip install --upgrade pip
          pip install pylint reviewdog

      - name: ðŸš¦ Run Pylint and report with Reviewdog
        if: steps.filter.outputs.python == 'true'
        run: |
          files=$(git diff --name-only origin/${{ github.base_ref }}...${{ github.head_ref }} | grep '\.py$')
          echo "ðŸ”Ž Linting changed files: $files"
          if [ -z "$files" ]; then
            echo "No Python files to lint."
            exit 0
          fi
          pylint $files --output-format=parseable > pylint.log 2>&1 || true
          # Reviewdog integration for inline PR comments
          reviewdog -f=pylint -name="Pylint" -reporter=github-pr-review -level=error < pylint.log

      # Step 6: Upload Pylint log as artifact
      - name: ðŸ“¤ Upload Pylint log
        if: steps.filter.outputs.python == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: pylint-log
          path: pylint.log

      # Step 7: Auto-approve PR if lint passes
      - name: ðŸ¤– Auto-approve PR if lint passed
        if: steps.filter.outputs.python == 'true' && success()
        run: |
          # Check if pylint.log contains errors
          if [ -s pylint.log ]; then
            echo "âŒ Lint errors detected. Skipping auto-approve."
            exit 1
          else
            echo "âœ… No lint issues. Auto-approving PR..."
            gh pr review ${{ github.event.pull_request.number }} --approve --body "Auto-approved"
        env:
          GITHUB_TOKEN: ${{ secrets.INFOYOUTH_PAT }}
